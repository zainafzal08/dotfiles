#!/usr/bin/env node
/** Original bash script:

delete=$(ls ~/repos/qwilr | grep -v '^master' | );

if [ -z "$delete" ]; then
    exit 1
fi

if [ "$WORKTREE" == "$delete" ]; then
    echo "Currently running $WORKTREE, deleting it..."
    pm2 delete all;
fi

cd ~/repos/qwilr/master
git worktree remove "../$delete"
if [ -d "~/repos/qwilr/$delete" ]; then
    rm -r "~/repos/qwilr/$delete"
fi
*/

const fs = require("fs");
const { MultiSelect } = require("enquirer");
const { execSync } = require("child_process");

async function main() {
  const branches = fs
    .readdirSync("/Users/zafzal/repos/qwilr")
    .filter((dir) => dir !== "master");

  const prompt = new MultiSelect({
    name: "value",
    message: "Which branches die today?",
    limit: branches.length,
    choices: branches.map((b) => ({ name: b, value: b })),
  });

  const answer = await prompt.run();
  for (const branch of answer) {
    console.log(`↳ Removing ${branch}...`);
    const worktree = process.env.WORKTREE;
    if (worktree === branch) {
      console.log(`  ↳ Currently running ${branch}, shutting it down`);
      execSync(`pm2 delete all`);
    }
    console.log(`  ↳ Removing Worktree`);
    execSync(`git worktree remove "../${branch}"`, {
      cwd: "/Users/zafzal/repos/qwilr/master",
    });
  }
}

main();
